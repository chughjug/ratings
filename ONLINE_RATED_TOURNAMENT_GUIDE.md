# Online Rated Tournament Guide

## Overview

The **Online Rated** tournament format creates Lichess Swiss tournaments that automatically generate pairings per round. This format leverages Lichess's official Swiss pairing system for fair, server-side pairings.

## Features

- **Automatic Swiss pairings** generated by Lichess
- **Official rating calculations** through Lichess
- **Player cap** of ~5,000 players
- **Server-side pairings** ensuring fairness
- **Integrated game management** with auto-pairing avoidance
- **Color balancing** handled by Lichess
- **Bye handling** for odd numbers of players

## How It Works

### 1. Tournament Creation

When creating a tournament, select **"Online Rated (Lichess Swiss)"** as the format:

```typescript
{
  format: 'online-rated',
  name: 'Monthly Rapid Swiss',
  rounds: 7,
  // ... other tournament settings
}
```

### 2. Lichess Integration Setup

To use this format, you need:

1. **Lichess account**: Sign up at [lichess.org](https://lichess.org)
2. **Lichess team**: Create or join a team at [lichess.org/team](https://lichess.org/team)
   - Must be a team leader to create tournaments
   - Note your team slug (e.g., `coders` from URL: `lichess.org/team/coders`)
3. **API token**: Generate at [lichess.org/account/oauth/token/create](https://lichess.org/account/oauth/token/create)
   - App name: e.g., "Tournament Pairings"
   - Scopes: Check **tournament:write**
   - Keep the token secret (starts with `lip_...`)

### 3. Creating a Lichess Swiss Tournament

Use the `LichessSwissIntegration` module:

```javascript
const LichessSwissIntegration = require('./server/utils/lichessSwissIntegration');

const lichess = new LichessSwissIntegration({
  token: 'YOUR_LICHESS_TOKEN'
});

const result = await lichess.createSwissTournament({
  teamId: 'coders',
  name: 'My Rapid Swiss',
  clock: { limit: 180, increment: 2 },
  variant: 'standard',
  rated: true,
  nbRounds: 5,
  description: 'Join via team link!'
});

if (result.success) {
  console.log('Tournament created:', result.id);
  console.log('Public URL:', result.publicUrl);
}
```

#### Required Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `teamId` | string | Your team slug (required) |
| `name` | string | Tournament name (required) |
| `clock` | object | Clock settings `{limit: seconds, increment: seconds}` (required) |
| `variant` | string | Chess variant, default: `standard` |
| `rated` | boolean | Whether rated, default: `true` |

#### Optional Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `nbRounds` | number | Number of rounds |
| `minutes` | number | Tournament duration in minutes (auto-pauses) |
| `startsAt` | number | Start time (Unix timestamp in ms) |
| `description` | string | Tournament description (Markdown) |
| `pause` | object | Pause settings (e.g., `{days: true}` for weekends) |
| `password` | string | Password to restrict joins |

### 4. Managing Rounds

Lichess automatically generates pairings when you start a round:

1. **Start tournament**: Click **Start** on the Lichess tournament page
2. **Players join**: Share the tournament URL
3. **Advance round**: When ~90% games finish â†’ Click **Next round**
4. **Pairings auto-generated** each time!

### 5. Retrieving Pairings

Use the integration module to fetch pairings:

```javascript
// Get current round pairings
const roundPairings = await lichess.getRoundPairings(tournamentId, roundNumber);

// Convert to internal format
const internalPairings = lichess.convertPairingsToInternalFormat(
  roundPairings.data.pairings
);
```

#### Available Endpoints

```javascript
// Get tournament info (includes current round pairings)
await lichess.getSwissTournament(tournamentId);

// Get specific round pairings
await lichess.getRoundPairings(tournamentId, roundNum);

// Get current standings
await lichess.getStandings(tournamentId);

// Get all players
await lichess.getPlayers(tournamentId);

// Get all games
await lichess.getGames(tournamentId);
```

### 6. Converting Results

The integration module provides helper functions:

```javascript
// Convert Lichess game result to internal format
const result = lichess.convertGameResult('white'); // '1-0'
const draw = lichess.convertGameResult(null); // '1/2-1/2'

// Convert pairings array
const pairings = lichess.convertPairingsToInternalFormat(lichessPairings);
```

## API Endpoints

### Setup Lichess Tournament

Create or setup a Lichess Swiss tournament for your online-rated tournament.

**Endpoint**: `POST /api/pairings/online-rated/setup`

**Request Body**:
```json
{
  "tournamentId": "your-tournament-id",
  "lichessTeamId": "your-team-slug",
  "clock": {
    "limit": 180,
    "increment": 2
  },
  "variant": "standard",
  "description": "Tournament description",
  "password": "optional-password"
}
```

**Response**:
```json
{
  "success": true,
  "lichessTournamentId": "ABC123def",
  "publicUrl": "https://lichess.org/swiss/ABC123def",
  "message": "Lichess tournament created successfully"
}
```

### Sync Pairings from Lichess

Sync pairings from Lichess for a specific round.

**Endpoint**: `POST /api/pairings/online-rated/sync-pairings`

**Request Body**:
```json
{
  "tournamentId": "your-tournament-id",
  "round": 1
}
```

**Response**:
```json
{
  "success": true,
  "message": "Synced 20 pairings from Lichess",
  "pairings": [...]
}
```

### Get Standings from Lichess

Fetch current standings from Lichess.

**Endpoint**: `GET /api/pairings/online-rated/:tournamentId/standings`

**Response**:
```json
{
  "success": true,
  "standings": [...]
}
```

## Configuration

The Lichess integration can be configured in two ways:

### 1. Environment Variable (Global)
Set `LICHESS_API_TOKEN` environment variable for all online-rated tournaments.

### 2. Tournament-Specific Settings
Store the API token in tournament settings (recommended for multi-organization setups):

```javascript
const settings = {
  online_rated_settings: {
    lichess_api_token: "lip_YOUR_TOKEN",
    lichess_team_id: "your-team",
    clock_limit: 180,
    clock_increment: 2,
    variant: "standard",
    is_rated: true
  }
};
```

**Security Note**: When storing API tokens in tournament settings, ensure they are encrypted at rest.

## Usage Example

### Complete Setup

#### Step 1: Create Tournament

```javascript
POST /api/tournaments
{
  "name": "Monthly Rapid Swiss",
  "format": "online-rated",
  "rounds": 7,
  "settings": {
    "online_rated_settings": {
      "lichess_api_token": "lip_YOUR_TOKEN"
    }
  }
}
```

#### Step 2: Setup Lichess Tournament

```javascript
POST /api/pairings/online-rated/setup
{
  "tournamentId": "your-tournament-id",
  "lichessTeamId": "your-team-slug",
  "clock": {
    "limit": 180,
    "increment": 2
  },
  "variant": "standard"
}
```

#### Step 3: Sync Pairings Each Round

```javascript
POST /api/pairings/online-rated/sync-pairings
{
  "tournamentId": "your-tournament-id",
  "round": 1
}
```

#### Step 4: Get Standings Anytime

```javascript
GET /api/pairings/online-rated/your-tournament-id/standings
```

## Differences from Regular Swiss Format

| Feature | Regular Swiss | Online Rated |
|---------|---------------|--------------|
| Pairing generation | Local (bbpPairings) | Lichess server |
| Rating calculations | Local/USCF | Lichess ratings |
| Game management | Manual entry | Lichess integration |
| Player limits | No limit | ~5,000 max |
| Pairing validation | Local checks | Lichess validation |
| Fairness guarantees | Swiss algorithm | Lichess Swiss |

## Tips & Best Practices

1. **Team setup**: Create a dedicated Lichess team for your tournaments
2. **Rate limits**: Lichess allows ~1 request/sec; implement backoff on 429
3. **Testing**: Use an alt account/team for testing
4. **Monitoring**: Set up alerts for Lichess tournament status changes
5. **Sync**: Regularly fetch results from Lichess to keep data in sync
6. **Player validation**: Ensure Lichess usernames match player records

## Limitations

- **Player cap**: ~5,000 players maximum
- **Team required**: Players must join your team
- **Round management**: Manual advancement required
- **API rate limits**: 1 req/sec standard
- **Lichess dependencies**: Requires Lichess service availability

## Security Considerations

1. **Keep API token secret**: Store in environment variables
2. **Use HTTPS**: Always use secure connections
3. **Validate inputs**: Check all tournament parameters
4. **Error handling**: Handle Lichess API failures gracefully
5. **Token rotation**: Rotate API tokens periodically

## References

- [Lichess API Documentation](https://lichess.org/api)
- [Swiss Tournament API](https://lichess.org/api#tag/Swiss-tournaments)
- [Tournament Creation Guide](https://lichess.org/team/tournaments)
- [Source Code](https://github.com/lichess-org/lila/blob/master/modules/swiss/Pairing.scala)

## Support

For issues or questions:
1. Check Lichess API status: https://lichess.org/api/status
2. Review Lichess documentation
3. Check server logs for detailed error messages
4. Test with curl commands first before implementing

