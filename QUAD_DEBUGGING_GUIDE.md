# Quad Pairing Generation - Debugging Guide

## Error: "Unexpected token '<', "<!DOCTYPE " is not valid JSON"

This error means the API returned HTML instead of JSON. This typically happens when:

1. **Endpoint not found (404)** - Returns HTML error page
2. **Server crash** - Returns error page instead of JSON
3. **Middleware issue** - Request doesn't reach the endpoint

## Debugging Steps

### Step 1: Check Server is Running
```bash
# In terminal, verify server is running
ps aux | grep node
# Should see your server process running
```

### Step 2: Check Endpoint Registration
The endpoint should be at: `POST /api/pairings/generate/quad`

**Verify in file**: `/server/routes/pairings.js` (line ~2278)
```javascript
router.post('/generate/quad', async (req, res) => {
  // ... code ...
}
```

### Step 3: Check Server Logs
```bash
# Terminal 1: Start server with logs visible
npm start
# or
node server/index.js

# Terminal 2: Try to generate quads and watch logs
# Look for:
# - "Error generating quad pairings:"
# - Database errors
# - Module loading errors
```

### Step 4: Test API Directly
```bash
# Use curl to test the endpoint
curl -X POST http://localhost:3001/api/pairings/generate/quad \
  -H "Content-Type: application/json" \
  -d '{
    "tournamentId": "YOUR_TOURNAMENT_ID",
    "round": 1
  }'

# Should return JSON, not HTML
# Look for error message in response
```

### Step 5: Check QuadPairingSystem Import

**File**: `/server/routes/pairings.js` (line 6)
```javascript
const QuadPairingSystem = require('../utils/quadPairingSystem');
```

**Verify file exists**:
```bash
ls -la /server/utils/quadPairingSystem.js
# Should show the file
```

**Test require**:
```javascript
// In Node REPL:
const QuadPairingSystem = require('./server/utils/quadPairingSystem');
console.log(typeof QuadPairingSystem); // Should be 'function'
```

### Step 6: Check Database Connection

The error might be in database queries:
```bash
# Check if database file exists
ls -la /server/chess_tournaments.db

# Try querying directly
sqlite3 /server/chess_tournaments.db "SELECT COUNT(*) FROM players;"
```

### Step 7: Check Players in Tournament

No players = no pairings. Verify:
```sql
-- In SQLite:
SELECT COUNT(*) FROM players 
WHERE tournament_id = 'YOUR_TOURNAMENT_ID' 
AND status = 'active';

-- Should return > 0
```

## Common Issues & Solutions

### Issue 1: Module Not Found Error
**Error**: `Cannot find module '../utils/quadPairingSystem'`

**Solution**:
1. Verify file exists: `/server/utils/quadPairingSystem.js`
2. Check file path is correct
3. Restart server

### Issue 2: No Active Players
**Error**: `No active players found for quad pairing`

**Solution**:
1. Add players to tournament first
2. Ensure players have status: 'active'
3. Verify player records in database

### Issue 3: Tournament Not Found
**Error**: `Tournament not found`

**Solution**:
1. Verify tournament ID is correct
2. Check tournament exists in database
3. Use correct ID from tournament list

### Issue 4: Round-Robin Algorithm Error
**Error**: `No pairings generated by quad system`

**Solution**:
1. Check server logs for detailed error
2. Verify QuadPairingSystem code is valid
3. Ensure players have ratings

### Issue 5: Database Insert Error
**Error**: `Failed to store any pairings`

**Solution**:
1. Check pairings table schema
2. Verify all required columns exist
3. Check for database locks

## Server Error Log Example

When something goes wrong, you'll see logs like:

```
Error generating quad pairings: Error: No pairings generated by quad system
Error stack: Error: No pairings generated by quad system
    at /Users/aarushchugh/ratings/server/routes/pairings.js:2340
```

**This tells you**:
- What error occurred
- Which file and line number
- Stack trace for debugging

## Testing Workflow

### 1. Create Test Tournament
```bash
# In browser:
1. Create tournament → Format: "Quad System"
2. Save tournament
3. Note the tournament ID
```

### 2. Add Test Players
```bash
# Add at least 8 players
1. Go to tournament
2. Add players with ratings:
   - Player 1: 1800
   - Player 2: 1700
   - Player 3: 1600
   - Player 4: 1500
   - Player 5: 1400
   - Player 6: 1300
   - Player 7: 1200
   - Player 8: 1100
```

### 3. Test API Call
```bash
curl -X POST http://localhost:3001/api/pairings/generate/quad \
  -H "Content-Type: application/json" \
  -d '{"tournamentId": "YOUR_ID", "round": 1}'
```

### 4. Expected Response
```json
{
  "success": true,
  "message": "Quad pairings generated for round 1",
  "data": {
    "tournamentId": "...",
    "round": 1,
    "quadCount": 2,
    "totalGames": 4,
    "totalByes": 0,
    "quads": [...],
    "pairingsCount": 4
  }
}
```

## Enable Debug Logging

**Add to QuadPairingSystem.js** (top of generateTournamentQuadPairings):
```javascript
console.log('[QUAD DEBUG] Tournament ID:', tournamentId);
console.log('[QUAD DEBUG] Round:', round);
console.log('[QUAD DEBUG] Players fetched:', players.length);
console.log('[QUAD DEBUG] Quads created:', system.quads.length);
console.log('[QUAD DEBUG] Pairings generated:', pairings.length);
```

**Run server with debug output**:
```bash
DEBUG=* npm start
# or
node --trace-uncaught server/index.js
```

## Key Checkpoints

✅ Server running and responding
✅ /api/pairings/generate/quad endpoint exists
✅ QuadPairingSystem module loads
✅ Tournament exists in database
✅ Players exist and are active (status = 'active')
✅ Players have ratings for sorting
✅ Database connection working
✅ Pairings table exists with all columns
✅ No database locks or constraints
✅ Response is JSON (not HTML)

## Still Having Issues?

1. **Check console in browser** (F12) - Look for error messages
2. **Check terminal running server** - Look for error logs
3. **Check database directly** - Verify data integrity
4. **Check network tab** - See actual API response
5. **Restart server** - Clear any cached state
6. **Check recent changes** - Review what was modified

## Example Successful Flow

```
1. Browser: Click "Generate Quads" button
2. Frontend: Send POST to /api/pairings/generate/quad
3. Server: Log "Processing quad pairing request"
4. Server: Fetch players from database (8 players)
5. Server: Create quads (2 quads of 4)
6. Server: Generate round-robin pairings (4 games)
7. Server: Insert into database (4 pairings stored)
8. Server: Return JSON response
9. Frontend: Show alert "2 Quads | 4 Games | 0 Byes"
10. Frontend: Refresh pairings view
11. Browser: Display pairings organized by quad
```

---

**Version**: 1.0
**Updated**: October 24, 2025
**Purpose**: Debug and resolve quad pairing generation errors

